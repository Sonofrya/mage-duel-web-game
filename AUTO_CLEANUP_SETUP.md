# Настройка автоочистки неактивных комнат

## Описание

Система автоочистки автоматически удаляет комнаты, которые неактивны более 2 минут. Это помогает очищать заброшенные игры и освобождать ресурсы сервера.

## Установка

### 1. Создание таблицы активности

Выполните SQL скрипт для создания таблицы отслеживания активности:

```bash
mysql -u your_username -p your_database < setup_room_activity.sql
```

### 2. Настройка cron (Linux/macOS)

Добавьте задачу в crontab для автоматического запуска очистки каждые 30 секунд:

```bash
crontab -e
```

Добавьте строку:
```
* * * * * /path/to/your/project/run_cleanup.sh
* * * * * sleep 30; /path/to/your/project/run_cleanup.sh
```

### 3. Настройка планировщика задач (Windows)

1. Откройте "Планировщик задач" (Task Scheduler)
2. Создайте новую задачу
3. Настройте запуск `run_cleanup.bat` каждые 30 секунд

### 4. Ручной запуск очистки

Для ручного запуска очистки используйте:

**Linux/macOS:**
```bash
php cleanup_inactive_rooms.php
```

**Windows:**
```cmd
php cleanup_inactive_rooms.php
```

## Мониторинг

### Веб-интерфейс мониторинга

Откройте `room_monitor.html` в браузере для:
- Просмотра всех активных комнат
- Мониторинга статуса активности
- Ручного запуска очистки
- Удаления отдельных комнат

### Логи

Система ведет логи в:
- `error_log.txt` - основные логи ошибок
- `cleanup.log` - логи выполнения очистки

## Как это работает

### Отслеживание активности

Активность комнаты обновляется при:
- Присоединении игрока к комнате (`join_room.php`)
- Получении информации об игре (`get_game_info.php`)
- Игре карт (`play_cards.php`)

### Критерии удаления

Комната удаляется если:
- Последняя активность была более 2 минут назад
- В комнате нет активных игроков

### Процесс очистки

При удалении комнаты очищаются:
1. Игроки (`Players`)
2. Карты в руке (`Cards_in_hand`)
3. Выбранные карты (`Cards_chosen`)
4. Заклинания (`Spells`)
5. Активность комнаты (`room_activity`)
6. Сама игра (`Games`)

## Файлы системы

- `setup_room_activity.sql` - SQL для создания таблицы активности
- `update_room_activity.php` - обновление активности комнаты
- `cleanup_inactive_rooms.php` - основной скрипт очистки
- `run_cleanup.sh` - скрипт запуска для Linux/macOS
- `run_cleanup.bat` - скрипт запуска для Windows
- `room_monitor.html` - веб-интерфейс мониторинга
- `get_rooms_info.php` - API для получения информации о комнатах

## Настройка интервалов

Для изменения интервала неактивности отредактируйте `cleanup_inactive_rooms.php`:

```php
// Изменить с 2 минут на другое значение
WHERE ra.last_activity < DATE_SUB(NOW(), INTERVAL 5 MINUTE)
```

## Безопасность

- Система проверяет существование комнат перед удалением
- Все операции выполняются в транзакциях
- Логируются все операции очистки
- Веб-интерфейс доступен только администраторам

## Устранение неполадок

### Комнаты не удаляются

1. Проверьте права доступа к базе данных
2. Убедитесь, что cron/планировщик работает
3. Проверьте логи ошибок

### Ошибки в логах

1. Проверьте подключение к базе данных
2. Убедитесь, что все таблицы созданы
3. Проверьте права доступа к файлам

### Производительность

- Очистка выполняется быстро благодаря индексам
- Операции выполняются пакетами
- Логирование минимальное для производительности
